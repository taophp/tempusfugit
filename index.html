<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⏳ Tempus fugit, one square per week, artwork by Stéphane Mourey</title>
    <style>
        :root {
            --viewport-aspect-ratio: calc(100vh / 100vw);
            --background-luminosity: 0;
        }

        body {
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: rgb(var(--background-luminosity), var(--background-luminosity), var(--background-luminosity));
        }

        a {
            color: lightblue;
        }

        label,
        input,
        button,
        blockquote,
        footer {
            display: block;
            margin: auto;
            text-align: center;
        }

        blockquote {
            font-style: italic;
            border-left: 3px solid silver;
            margin: 1em;
            padding: 1em .5em 1em 1em;
            text-align: left;
            background-color: #222;
        }

        input {
            margin-bottom: 1em;
        }

        footer {
            position: fixed;
            bottom:0;
        }
        #container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .row {
            display: flex;
            flex: 1;
        }

        .week {
            flex-grow: 1;
            aspect-ratio: var(--viewport-aspect-ratio);
            border: solid 1px black;
            margin: 2px;
        }

        .week.past {
            background-color: black;
        }

        .week.future {
            background-color: white;
        }

        .week.current {
            animation: blink 2s infinite;
        }

        .week.empty {
            background-color: transparent;
            border-color: transparent;
        }

        @keyframes blink {
            50% {
                background-color: rgba(0, 0, 0, 0);
            }
        }

        #intro {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="intro">
            <h1>Tempus fugit</h1>
            <h2 id="subtitle"></h2>
            <h3><a href="https://stephanemourey.fr" target="_blank">Stéphane Mourey</a></h3>
            <blockquote id="quote"></blockquote>
            <form id="user-data-form">
                <label for="birthdate" id="birthdateLabel"></label>
                <input type="text" id="birthdate">
                <label for="lifeExpectancy" id="lifeExpectancyLabel"></label>
                <input type="number" id="lifeExpectancy" />
                <input type="submit"></input>
            </form>
            <p id="cure"></p>
        </div>
    </div>
    <footer id="footer">
        <a href="https://github.com/taophp/tempusfugit" target="_blank" alt="The Github page of the project">
            <svg height="64px" width="64px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 291.32 291.32" xml:space="preserve"
                fill="#000000">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <g>
                        <path style="fill:#ffffff;"
                            d="M145.66,0C65.219,0,0,65.219,0,145.66c0,80.45,65.219,145.66,145.66,145.66 s145.66-65.21,145.66-145.66C291.319,65.219,226.1,0,145.66,0z M186.462,256.625c-0.838-11.398-1.775-25.518-1.83-31.235 c-0.364-4.388-0.838-15.549-11.434-22.677c42.068-3.523,62.087-26.774,63.526-57.499c1.202-17.497-5.754-32.883-18.107-45.3 c0.628-13.282-0.401-29.023-1.256-35.941c-9.486-2.731-31.608,8.949-37.79,13.947c-13.037-5.062-44.945-6.837-64.336,0 c-13.747-9.668-29.396-15.64-37.926-13.974c-7.875,17.452-2.813,33.948-1.275,35.914c-10.142,9.268-24.289,20.675-20.447,44.572 c6.163,35.04,30.816,53.94,70.508,58.564c-8.466,1.73-9.896,8.048-10.606,10.788c-26.656,10.997-34.275-6.791-37.644-11.425 c-11.188-13.847-21.23-9.832-21.849-9.614c-0.601,0.218-1.056,1.092-0.992,1.511c0.564,2.986,6.655,6.018,6.955,6.263 c8.257,6.154,11.316,17.27,13.2,20.438c11.844,19.473,39.374,11.398,39.638,11.562c0.018,1.702-0.191,16.032-0.355,27.184 C64.245,245.992,27.311,200.2,27.311,145.66c0-65.365,52.984-118.348,118.348-118.348S264.008,80.295,264.008,145.66 C264.008,196.668,231.69,239.992,186.462,256.625z">
                        </path>
                    </g>
                </g>
            </svg>
        </a>
        <a href="https://twitter.com/ImpossibleExil" target="_blank" title="Follow on X (Twitter)"><svg fill="#fff" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="64px" height="64px" viewBox="0 0 33.88 33.88" xml:space="preserve" stroke="#fff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M30.414,10.031c0.014,0.297,0.021,0.595,0.021,0.897c0,9.187-6.992,19.779-19.779,19.779c-3.928,0-7.58-1.149-10.657-3.123 c0.546,0.063,1.099,0.095,1.658,0.095c3.26,0,6.254-1.107,8.632-2.974c-3.039-0.058-5.607-2.065-6.491-4.828 c0.424,0.082,0.858,0.125,1.308,0.125c0.635,0,1.248-0.084,1.83-0.244c-3.177-0.639-5.576-3.448-5.576-6.815 c0-0.029,0-0.058,0-0.087c0.939,0.521,2.01,0.833,3.15,0.869C2.646,12.48,1.419,10.35,1.419,7.938c0-1.274,0.343-2.467,0.94-3.495 c3.427,4.206,8.552,6.973,14.327,7.263c-0.117-0.509-0.18-1.038-0.18-1.584c0-3.838,3.112-6.949,6.953-6.949 c1.998,0,3.805,0.844,5.07,2.192c1.582-0.311,3.072-0.89,4.416-1.686c-0.521,1.624-1.621,2.986-3.057,3.844 c1.406-0.166,2.746-0.54,3.991-1.092C32.949,7.826,31.771,9.05,30.414,10.031z"></path> </g> </g></svg></a>
        <a href="https://www.facebook.com/stephane.mourey.14" target="_blank" alt="Facebook page"><svg fill="#fff" width="64px" height="64px" viewBox="0 0 32 32" id="Camada_1" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="#fff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><style type="text/css"> .st0{fill-rule:evenodd;clip-rule:evenodd;} </style><path class="st0" d="M12.6,16.1v11.6c0,0.2,0.1,0.3,0.3,0.3h4.6c0.2,0,0.3-0.1,0.3-0.3V15.9h3.4c0.2,0,0.3-0.1,0.3-0.3l0.3-3.6 c0-0.2-0.1-0.3-0.3-0.3h-3.7V9.2c0-0.6,0.5-1.1,1.2-1.1h2.6C21.9,8.1,22,8,22,7.8V4.3C22,4.1,21.9,4,21.7,4h-4.4 c-2.6,0-4.7,1.9-4.7,4.3v3.4h-2.3c-0.2,0-0.3,0.1-0.3,0.3v3.6c0,0.2,0.1,0.3,0.3,0.3h2.3V16.1z"></path></g></svg></a>
        <a href="https://www.linkedin.com/in/st%C3%A9phane-mourey-7b61b6a8" target="_blank" title="Follow on LinkedId"><svg fill="#fff" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="64px" height="64px" viewBox="0 0 32 32" xml:space="preserve" stroke="#fff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M17.303,14.365c0.012-0.015,0.023-0.031,0.031-0.048v0.048H17.303z M32,0v32H0V0H32L32,0z M9.925,12.285H5.153v14.354 h4.772V12.285z M10.237,7.847c-0.03-1.41-1.035-2.482-2.668-2.482c-1.631,0-2.698,1.072-2.698,2.482 c0,1.375,1.035,2.479,2.636,2.479h0.031C9.202,10.326,10.237,9.222,10.237,7.847z M27.129,18.408c0-4.408-2.355-6.459-5.494-6.459 c-2.531,0-3.664,1.391-4.301,2.368v-2.032h-4.77c0.061,1.346,0,14.354,0,14.354h4.77v-8.016c0-0.434,0.031-0.855,0.157-1.164 c0.346-0.854,1.132-1.746,2.448-1.746c1.729,0,2.418,1.314,2.418,3.246v7.68h4.771L27.129,18.408L27.129,18.408z"></path> </g> </g></svg></a>
        <p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"><span property="dct:title">Tempus Fugit</span> by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://stephanemourey.fr">Stéphane Mourey</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC-SA 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a></p> 
    </footer>

    <script>
        const messages = {
            fr: {
                birthdate: "Votre date de naissance",
                birthdateFormat: "jj/mm/aaaa",
                lifeExpectancy: "Le nombre d'années que vous espérez vivre",
                invalidDate: "Date invalide. Veuillez réessayer.",
                invalidNumber: "Veuillez entrer un nombre entier valide. Réessayez.",
                here: "Vous êtes ici",
                motto: "La seule chose que vous maîtrisez, c'est ce à quoi vous allez consacrer le reste de votre temps.",
                subtitle: "Une case par semaine",
                cure: "Pour soigner la procrastination, faire de ce site votre page d'accueil.",
            },
            en: {
                birthdate: "Your birth date",
                birthdateFormat: "dd/mm/yyyy",
                lifeExpectancy: "The number of years you hope to live:",
                invalidDate: "Invalid date. Please try again.",
                invalidNumber: "Please enter a valid integer. Try again.",
                here: "You are here",
                motto: "The only thing you control is what you will spend the rest of your time on.",
                subtitle: "One square per week",
                cure: "To cure procrastination, make this site your home page.",

            },
        };

        const oneDay = 24 * 60 * 60 * 1000;

        const Dd = new Date();

        document.getElementById("birthdate").focus();
        document.getElementById("birthdate").placeholder = getMessagesForLanguage().birthdateFormat;
        document.getElementById("quote").textContent = getMessagesForLanguage().motto;
        document.getElementById("subtitle").textContent = getMessagesForLanguage().subtitle;
        document.getElementById("cure").textContent = getMessagesForLanguage().cure;

        const birthdateLabel = document.getElementById("birthdateLabel");
        birthdateLabel.textContent = getMessagesForLanguage().birthdate;

        const lifeExpectancyLabel = document.getElementById("lifeExpectancyLabel");
        lifeExpectancyLabel.textContent = getMessagesForLanguage().lifeExpectancy;

        function getMessagesForLanguage() {
            const userLanguages = navigator.languages || [navigator.language || navigator.userLanguage];

            for (const userLanguage of userLanguages) {
                for (const [lang, _] of Object.entries(messages)) {
                    if (userLanguage.startsWith(lang)) {
                        return messages[lang];
                    }
                }
            }

            return messages.en;
        }


        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(`${name}=`)) {
                    return decodeURIComponent(cookie.substring(`${name}=`.length));
                }
            }
            return null;
        }
        function getBirthdateFromForm() {
            const birthdateInput = document.getElementById("birthdate");
            const birthdate = new Date(birthdateInput.value.split("/").reverse().join("-"));

            if (isNaN(birthdate)) {
                alert(messages.invalidDate);
                birthdateInput.focus();
                return null;
            }

            return birthdate;
        }

        function getLifeExpectancyFromForm() {
            const lifeExpectancyInput = document.getElementById("lifeExpectancy");
            const lifeExpectancy = parseInt(lifeExpectancyInput.value);

            if (Number.isNaN(lifeExpectancy) || !Number.isInteger(lifeExpectancy)) {
                alert(messages.invalidNumber);
                lifeExpectancyInput.focus();
                return null;
            }

            return lifeExpectancy;
        }

        function calculateWeeksBetween(startDate, endDate) {
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            const timeDifference = end - start;
            return Math.ceil(timeDifference / (1000 * 60 * 60 * 24 * 7));
        }

        function isWeekPast(weekStart) {
            const currentDate = new Date();
            return weekStart < currentDate;
        }

        function isCurrentWeek(weekStart) {
            const currentDate = new Date();
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            if (currentDate >= weekStart && currentDate <= weekEnd) {
                return currentDate.getDay();
            }

            return -1;
        }


        function setCurrentWeekLuminosity(weekElement) {
            const currentDay = new Date().getDay();
            const luminosity = 255 - Math.round((255 * currentDay) / 6);
            weekElement.style.backgroundColor = `rgb(${luminosity}, ${luminosity}, ${luminosity})`;
        }

        function calculateColumns(rows, totalWeeks) {
            const columns = Math.ceil(totalWeeks / rows);
            return Math.max(columns, Math.ceil(totalWeeks / (rows - 1)));
        }

        function createEmptyWeekElement() {
            const weekElement = document.createElement("div");
            weekElement.classList.add("week", "empty");
            return weekElement;
        }

        function setFutureWeekLuminosity(weekElement, futureWeeks) {
            const maxFutureWeeks = Math.ceil((De - Dd) / (7 * oneDay));
            const luminosityFactor = futureWeeks / maxFutureWeeks;
            const luminosity = 255 - Math.round(255 * luminosityFactor);
            weekElement.style.backgroundColor = `rgb(${luminosity}, ${luminosity}, ${luminosity})`;
        }

        async function run(birthdate, lifeExpectancy) {
            document.getElementById("intro").remove();
            document.getElementById("footer").remove();

            Ds = birthdate;
            const lifeExpectancyInt = parseInt(lifeExpectancy);
            De = new Date(Ds.getFullYear() + lifeExpectancyInt, Ds.getMonth(), Ds.getDate());

            const diffDsDd = Math.round(Math.abs((Ds - Dd) / oneDay));
            const diffDsDe = Math.round(Math.abs((Ds - De) / oneDay));
            const backgroundLuminosity = 255 - Math.round((255 * diffDsDd) / diffDsDe);
            document.body.style.setProperty('--background-luminosity', backgroundLuminosity);

            const weeksBetween = calculateWeeksBetween(Ds, De);
            const totalWeeks = weeksBetween;
            const squareRoot = Math.sqrt(totalWeeks);
            const rows = Math.ceil(squareRoot);
            const columns = calculateColumns(rows, totalWeeks);
            for (let i = 0; i < weeksBetween; i++) {
                const weekElement = document.createElement("div");
                weekElement.classList.add("week");

                if (i % columns === 0) {
                    const row = document.createElement("div");
                    row.classList.add("row");
                    container.appendChild(row);
                }
                const lastRow = container.lastChild;
                lastRow.appendChild(weekElement);

                const weekStart = new Date(Ds);
                weekStart.setDate(Ds.getDate() + i * 7);

                const currentWeekDay = isCurrentWeek(weekStart);
                if (currentWeekDay !== -1) {
                    weekElement.classList.add("current");
                    weekElement.title = getMessagesForLanguage().here;
                    setCurrentWeekLuminosity(weekElement);
                } else if (isWeekPast(weekStart)) {
                    weekElement.classList.add("past");
                } else {
                    weekElement.classList.add("future");
                    const futureWeeks = Math.ceil((weekStart - Dd) / (7 * oneDay));
                    setFutureWeekLuminosity(weekElement, futureWeeks)
                }

                lastRow.appendChild(weekElement);

                if (i === totalWeeks - 1 && lastRow.childElementCount < columns) {
                    for (let j = lastRow.childElementCount; j < columns; j++) {
                        lastRow.appendChild(createEmptyWeekElement());
                    }
                }
                await new Promise(r => setTimeout(r, 1));
            }
        }

        document.getElementById("user-data-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const birthdate = getBirthdateFromForm();
            if (!birthdate) {
                return;
            }

            const lifeExpectancy = getLifeExpectancyFromForm();
            if (lifeExpectancy === null) {
                return;
            }

            setCookie("birthdate", birthdate.toISOString().split("T")[0], 365);
            setCookie("lifeExpectancy", lifeExpectancy, 365);

            await run(birthdate, lifeExpectancy);
        });

        birthdateCookie = getCookie("birthdate")
        lifeExpectancyCookie = getCookie("lifeExpectancy")
        if (birthdateCookie && lifeExpectancyCookie) {
            let submitTimeout;
            document.getElementById("birthdate").value = birthdateCookie ? birthdateCookie.split("-").reverse().join("/") : "";
            document.getElementById("lifeExpectancy").value = lifeExpectancyCookie || "";
            submitTimeout = setTimeout(() => { document.getElementById("user-data-form").dispatchEvent(new Event("submit")) }, 10000);
            const birthdateInput = document.getElementById("birthdate");
            const lifeExpectancyInput = document.getElementById("lifeExpectancy");

            birthdateInput.addEventListener("input", () => {
                if (submitTimeout) {
                    clearTimeout(submitTimeout);
                }
            });

            lifeExpectancyInput.addEventListener("input", () => {
                if (submitTimeout) {
                    clearTimeout(submitTimeout);
                }
            });
        }

    </script>

</body>

</html>